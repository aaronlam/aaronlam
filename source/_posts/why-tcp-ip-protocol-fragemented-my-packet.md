---
title: 为什么TCP/IP要拆分我的数据
date: 2019-05-31 21:00:00
tags:
  - TCP
  - 网络
  - 数据包
categories:
  - 网络
---

TCP/IP 作为目前互联网举足轻重的网络通信协议，不是没有它的道理。TCP/IP 提供供了点对点的链接机制，以让源机器中的源进程发出的数据能够送达目标机器的目标进程里去，这其中的**资料封装、寻址、传输、路由、接收**都会以标准化的操作完成，并且它们还能保证数据在传输过程中**有序**、**不重**、**不漏**。

但是你不知道的是，当应用层协议使用传输层的 TCP 协议进行数据传输时，传输层 TCP 协议可能会将应用层所发送的消息分成多个数据段，我们一般称呼它叫：**TCP 分段**。而在其下层的网络层 IP 协议也有可能会对传输层 TCP 协议的数据段分成多个数据包，我们一般称呼它叫：**IP 分片**。但是由于 TCP 协议会自行先分段，所以正常情况下都轮不到 IP 协议进行分片。那为什么它们要拆分我们的数据呢？又为什么 TCP 协议自行分段后，就没 IP 协议什么事了呢？我们带着这些疑问继续探索。

<!--more-->

![TCP分段IP分包](https://cdn.jsdelivr.net/gh/aaronlam/imghosting/20201031123646.png)

在开始之前，我们先达成共识：

1. 协议层中传输数据的基本单位统称为：Data Unit（数据单元）
2. 网络层传输的数据单元称为：Packet(包）
3. 传输层传输的数据单元称为：Segment（段）
4. 应用层传输的数据单元称为：Message（消息）

并且，我们把前提摘要先提前放出来：

1. IP 协议会分片传输过大的数据包避免物理设备的限制
2. TCP 协议会分段传输过大的数据段保证整体的传输性能，同时能避免遭到 IP 协议分片

# 最大传输单元

IP 协议适用于传输数据包的协议，作为网络层协议，它能提供数据的**路由**和**寻址**功能，让数据能通过网络到达目的地。但是由于现实中物理设备的限制，导致传输于网络中的数据包不能太大，所以在不同设备进行数据传输前，需要先确定一个 IP 数据包的大小上限，既最大传输单元（MTU）,MTU 是 IP 数据包能够传输的数据大小上限。

MTU 的值不是越大越好，更大的 MTU 意味着更低的额外开销，但会加大丢包所带来的风险。更小的 MTU 意味着更低的网络延迟，但太小又会出现额外开销的加大。所以有一个合适 MTU 值对于网络传输来说是非常重要的，每一个物理设备都自己的 MTU，两个主机之间的 MTU 依赖其底层的网络能力，它由整个链路上 MTU 最小的那台物理设备所决定。如下图所示，最小的 MTU 为：1000：

![链路MTU发现](https://cdn.jsdelivr.net/gh/aaronlam/imghosting/20201031133126.png)

路径最大传输单元发现（Path MTU Discovery，PMTUD）是用来确定两个主机数据传输 MTU 的机制，它的工作原理如下：

1. 向目的主机发送数据包头 DF 控制位设置为 1 的 IP 数据包 ，DF 是不分片（Don't Fragment）的缩写
2. 路径上的物理设备会根据数据包的大小和自己的 MTU 比较，做出不同的决定：
   1. 如果数据包的大小大于设备的 MTU，就会丢弃数据包并发回一个包含该设备 MTU 的 ICMP 的消息
   2. 如果数据包小于设备的 MTU，就会继续向目的主机传递数据包
3. 源主机收到 ICMP 消息后，会不断使用新的 MTU 发送 IP 数据包，直到 IP 数据包到达目标主机

> ICMP 是互联网控制协议（Internet Control Message Protocol），它能在 IP 主机之间传递控制消息

位于第二层的以太网协议对其数据帧的限制一般都是 1500 字节，所以在一般情况下，IP 主机的路径 MTU 都是 1500，扣除 IP 协议数据包头部占用的 20 字节，则如果数据包内的数据大于 1480 字节，那么 IP 协议就开始拆分我们的数据，把数据分到多个数据包中分片传输。

IP 协议的数据包分片对于传输层协议是透明的，假设我们使用 UDP 协议传输 2000 字节的数据，加上 UDP 协议报头占用的 8 字节，则 IP 协议需要传输 2008 字节的数据，但是当 IP 协议发现自己的路径 MTU 是 1480 字节时，就会对 UDP 的数据报进行拆分。如下图所示：
